/**
 * @author ydr.me
 * @create 2015-07-05 22:40
 */

'use strict';

var typeis = require('./typeis.js');
var number = require('./number.js');
var string = require('./string.js');
var lang = require('./_validation-lang.js');

var REG_NUMBERIC = /^-?[\d.]+$/;

module.exports = function (Validation) {
    Validation.addRule('trim', function (val, done, param0) {
        if (param0) {
            this.data[this.path] = typeis(val) === 'string' || typeis(val) === 'number' ? String(val).trim() : '';
        }

        done();
    });

    Validation.addRule('type', function (val, done, param0) {
        var the = this;
        var path = the.path;
        var isRequired = the.getRuleParams(path, 'required');
        isRequired = isRequired ? isRequired[0] : true;
        var alias = the.getAlias(path) || path;

        if (!isRequired && !val) {
            return done(null);
        }

        switch (param0) {
            case 'array':
                return done(typeis(val) === 'array' ? null : string.assign(lang.get('type', 'array'), alias, param0));

            case 'number':
                return done(/^-?\d+$/.test(val) ? null : string.assign(lang.get('type', 'number'), alias, param0));
            case 'decimal':
                return done(/^\d*\.?\d*$/.test(val) ? null : string.assign(lang.get('type', 'number'), alias, param0));
            case 'number_positive':
                return done(/^\d+(\.\d{1,3})?$/.test(val) ? null : string.assign(lang.get('type', 'number'), alias, param0));
            case 'integer':
                if (typeof val === 'number') {
                    val = val.toString();
                }
                val = val.replace(/^-/, '');
                return done(/^(0|[1-9]\d*)$/.test(val) ? null : string.assign(lang.get('type', 'integer'), alias, param0));

            case 'mobile':
                return done(/^1\d{10}$/.test(val) ? null : string.assign(lang.get('type', 'mobile'), alias, param0));

            case 'email':
                return done(typeis.email(val) ? null : string.assign(lang.get('type', 'email'), alias, param0));

            case 'url':
                return done(typeis.url(val) ? null : string.assign(lang.get('type', 'url'), alias, param0));
            case 'dateDMY':
                return done(typeis.date(val) ? null : string.assign(lang.get('type', 'date'), alias, param0));
            case 'dateYMD':
                return done(typeis.date(val, true) ? null : string.assign(lang.get('type', 'date'), alias, param0));
            case 'dateDMYHm':
                return done(typeis.dateTimeToMinute(val) ? null : string.assign(lang.get('type', 'date'), alias, param0));
            case 'dateYMDHm':
                return done(typeis.dateTimeToMinute(val, true) ? null : string.assign(lang.get('type', 'date'), alias, param0));
            case 'numreicAllowZero':
                if (typeof val === 'number') {
                    val = val.toString();
                }
                return done(/^[0-9]*$/.test(val) ? null : string.assign(lang.get('type', 'numreicAllowZero'), alias, param0));

        }
    });

    Validation.addRule('required', function (val, done, param0) {
        if (!param0) {
            return done();
        }
        var convertVal = typeof val === 'number' ? val.toString() : val;
        var isMultiple = _isMultiple(convertVal);
        var boolean = typeis(convertVal) === 'file' ? true : (isMultiple ? convertVal : convertVal || '').length > 0;
        //done(boolean ? null : '${path}不能为空');
        done(boolean ? null : lang.get('required'));
    });

    var _createLength = function _createLength(type) {
        var typeMap = {
            0: 'minLength',
            1: 'maxLength'
        };

        return function (val, done, param0) {
            param0 = number.parseInt(param0);
            var convertVal = typeof val === 'number' ? val.toString() : val;
            var requiredParams = this.getRuleParams(this.path, 'required');
            var required = requiredParams ? requiredParams[0] : true;
            var isMultiple = _isMultiple(convertVal);
            var length = (isMultiple ? convertVal : convertVal || '').length;
            var boolean = type === 0 ? length >= param0 : length <= param0;

            // 未填 && 可选
            if (!length && !required) {
                return done();
            }

            if (isMultiple) {
                done(boolean ? null : lang.get(typeMap[type], 'select'));
            } else {
                done(boolean ? null : lang.get(typeMap[type], 'input'));
            }
        };
    };

    Validation.addRule('minLength', _createLength(0));
    Validation.addRule('maxLength', _createLength(1));

    Validation.addRule('equal', function (val, done, param0) {
        val = val || '';
        done(val === this.getData(param0) ? null : '${1}必须与' + this.getAlias(param0) + '相同');
    });

    var _createNumber = function _createNumber(type) {
        return function (val, done, param0) {
            val = val || '';

            var isRequired = this.getRuleParams(this.path, 'required');
            isRequired = isRequired ? isRequired[0] : true;
            // 非必填并且是空值
            if (!isRequired && (val == "" || val == null || typeof val == "undefined")) {
                return done(null);
            }

            if (!REG_NUMBERIC.test(val)) {
                return done('${1}必须为数值格式');
            }

            val = number.parseFloat(val);
            param0 = number.parseFloat(param0);

            var boolean = type === 0 ? val >= param0 : val <= param0;

            done(boolean ? null : lang.get(type ? 'max' : 'min'));
        };
    };

    Validation.addRule('min', _createNumber(0));
    Validation.addRule('max', _createNumber(1));
    Validation.addRule('step', function (val, done, param0) {
        val = val || '';

        var isRequired = this.getRuleParams(this.path, 'required');

        // 非必填并且是空值
        if (!isRequired && !val) {
            return done(null);
        }

        if (!REG_NUMBERIC.test(val)) {
            return done('${1}必须为数值格式');
        }

        var min = this.getRuleParams(this.path, 'min')[0];

        val = number.parseInt(val, 0);
        param0 = number.parseInt(param0, 0);

        if (!param0) {
            return done(null);
        }

        done((val - min) % param0 ? '${1}递增步进值必须是' + param0 + '，最小值为' + min : null);
    });

    var _createSelect = function _createSelect(type) {
        return function (val, done, param0) {
            if (!param0) {
                return done();
            }

            if (typeis(val) !== 'array') {
                return done('${1}必须为数组格式');
            }

            var length = val.length;

            // most
            if (type) {
                done(length > param0 ? lang.get('most') : null);
            }
            // least
            else {
                    done(length < param0 ? lang.get('least') : null);
                }
        };
    };

    Validation.addRule('least', _createSelect(0));
    Validation.addRule('most', _createSelect(1));
};

//============================================================
//============================================================
//============================================================

/**
 * 判断是否为多值类型
 * @param obj
 * @returns {boolean}
 */
function _isMultiple(obj) {
    return typeis.array(obj) || typeis(obj) === 'filelist';
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy92YWxpZGF0b3IvbGlicy9fdmFsaWRhdGlvbi1ydWxlcy5qcyJdLCJuYW1lcyI6WyJ0eXBlaXMiLCJyZXF1aXJlIiwibnVtYmVyIiwic3RyaW5nIiwibGFuZyIsIlJFR19OVU1CRVJJQyIsIm1vZHVsZSIsImV4cG9ydHMiLCJWYWxpZGF0aW9uIiwiYWRkUnVsZSIsInZhbCIsImRvbmUiLCJwYXJhbTAiLCJkYXRhIiwicGF0aCIsIlN0cmluZyIsInRyaW0iLCJ0aGUiLCJpc1JlcXVpcmVkIiwiZ2V0UnVsZVBhcmFtcyIsImFsaWFzIiwiZ2V0QWxpYXMiLCJhc3NpZ24iLCJnZXQiLCJ0ZXN0IiwidG9TdHJpbmciLCJyZXBsYWNlIiwiZW1haWwiLCJ1cmwiLCJkYXRlIiwiZGF0ZVRpbWVUb01pbnV0ZSIsImNvbnZlcnRWYWwiLCJpc011bHRpcGxlIiwiX2lzTXVsdGlwbGUiLCJib29sZWFuIiwibGVuZ3RoIiwiX2NyZWF0ZUxlbmd0aCIsInR5cGUiLCJ0eXBlTWFwIiwicGFyc2VJbnQiLCJyZXF1aXJlZFBhcmFtcyIsInJlcXVpcmVkIiwiZ2V0RGF0YSIsIl9jcmVhdGVOdW1iZXIiLCJwYXJzZUZsb2F0IiwibWluIiwiX2NyZWF0ZVNlbGVjdCIsIm9iaiIsImFycmF5Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7QUFNQTs7QUFFQSxJQUFJQSxTQUFTQyxRQUFRLGFBQVIsQ0FBYjtBQUNBLElBQUlDLFNBQVNELFFBQVEsYUFBUixDQUFiO0FBQ0EsSUFBSUUsU0FBU0YsUUFBUSxhQUFSLENBQWI7QUFDQSxJQUFJRyxPQUFPSCxRQUFRLHVCQUFSLENBQVg7O0FBRUEsSUFBSUksZUFBZSxZQUFuQjs7QUFFQUMsT0FBT0MsT0FBUCxHQUFpQixVQUFVQyxVQUFWLEVBQXNCO0FBQ25DQSxlQUFXQyxPQUFYLENBQW1CLE1BQW5CLEVBQTJCLFVBQVVDLEdBQVYsRUFBZUMsSUFBZixFQUFxQkMsTUFBckIsRUFBNkI7QUFDcEQsWUFBSUEsTUFBSixFQUFZ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QyxnQkFBSSxDQUFDQSxNQUFMLEVBQWE7QUFDVCx1QkFBT0QsTUFBUDtBQUNIOztBQUVELGdCQUFJWCxPQUFPVSxHQUFQLE1BQWdCLE9BQXBCLEVBQTZCO0FBQ3pCLHVCQUFPQyxLQUFLLGFBQUwsQ0FBUDtBQUNIOztBQUVELGdCQUFJd0IsU0FBU3pCLElBQUl5QixNQUFqQjs7QUFFQTtBQUNBLGdCQUFJRSxJQUFKLEVBQVU7QUFDTjFCLHFCQUFLd0IsU0FBU3ZCLE1BQVQsR0FBa0JSLEtBQUttQixHQUFMLENBQVMsTUFBVCxDQUFsQixHQUFxQyxJQUExQztBQUNIO0FBQ0Q7QUFIQSxpQkFJSztBQUNEWix5QkFBS3dCLFNBQVN2QixNQUFULEdBQWtCUixLQUFLbUIsR0FBTCxDQUFTLE9BQVQsQ0FBbEIsR0FBc0MsSUFBM0M7QUFDSDtBQUNKLFNBbkJEO0FBb0JILEtBckJEOztBQXVCQWYsZUFBV0MsT0FBWCxDQUFtQixPQUFuQixFQUE0QnFDLGNBQWMsQ0FBZCxDQUE1QjtBQUNBdEMsZUFBV0MsT0FBWCxDQUFtQixNQUFuQixFQUEyQnFDLGNBQWMsQ0FBZCxDQUEzQjtBQUNILENBaE1EOztBQW1NQTtBQUNBO0FBQ0E7O0FBRUE7Ozs7O0FBS0EsU0FBU2IsV0FBVCxDQUFxQmMsR0FBckIsRUFBMEI7QUFDdEIsV0FBTy9DLE9BQU9nRCxLQUFQLENBQWFELEdBQWIsS0FBcUIvQyxPQUFPK0MsR0FBUCxNQUFnQixVQUE1QztBQUNIIiwiZmlsZSI6Il92YWxpZGF0aW9uLXJ1bGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAYXV0aG9yIHlkci5tZVxuICogQGNyZWF0ZSAyMDE1LTA3LTA1IDIyOjQwXG4gKi9cblxuXG4ndXNlIHN0cmljdCc7XG5cbnZhciB0eXBlaXMgPSByZXF1aXJlKCcuL3R5cGVpcy5qcycpO1xudmFyIG51bWJlciA9IHJlcXVpcmUoJy4vbnVtYmVyLmpzJyk7XG52YXIgc3RyaW5nID0gcmVxdWlyZSgnLi9zdHJpbmcuanMnKTtcbnZhciBsYW5nID0gcmVxdWlyZSgnLi9fdmFsaWRhdGlvbi1sYW5nLmpzJyk7XG5cbnZhciBSRUdfTlVNQkVSSUMgPSAvXi0/W1xcZC5dKyQvO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChWYWxpZGF0aW9uKSB7XG4gICAgVmFsaWRhdGlvbi5hZGRSdWxlKCd0cmltJywgZnVuY3Rpb24gKHZhbCwgZG9uZSwgcGFyYW0wKSB7XG4gICAgICAgIGlmIChwYXJhbTApIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YVt0aGlzLnBhdGhdID0gdHlwZWlzKHZhbCkgPT09ICdzdHJpbmcnIHx8IHR5cGVpcyh2YWwpID09PSAnbnVtYmVyJyA/XG4gICAgICAgICAgICAgICAgU3RyaW5nKHZhbCkudHJpbSgpIDogJyc7XG4gICAgICAgIH1cblxuICAgICAgICBkb25lKCk7XG4gICAgfSk7XG5cbiAgICBWYWxpZGF0aW9uLmFkZFJ1bGUoJ3R5cGUnLCBmdW5jdGlvbiAodmFsLCBkb25lLCBwYXJhbTApIHtcbiAgICAgICAgdmFyIHRoZSA9IHRoaXM7XG4gICAgICAgIHZhciBwYXRoID0gdGhlLnBhdGg7XG4gICAgICAgIHZhciBpc1JlcXVpcmVkID0gdGhlLmdldFJ1bGVQYXJhbXMocGF0aCwgJ3JlcXVpcmVkJyk7XG4gICAgICAgIGlzUmVxdWlyZWQgPSBpc1JlcXVpcmVkID8gaXNSZXF1aXJlZFswXSA6IHRydWU7XG4gICAgICAgIHZhciBhbGlhcyA9IHRoZS5nZXRBbGlhcyhwYXRoKSB8fCBwYXRoO1xuXG4gICAgICAgIGlmICghaXNSZXF1aXJlZCAmJiAhdmFsKSB7XG4gICAgICAgICAgICByZXR1cm4gZG9uZShudWxsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN3aXRjaCAocGFyYW0wKSB7XG4gICAgICAgICAgICBjYXNlICdhcnJheSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUodHlwZWlzKHZhbCkgPT09ICdhcnJheScgPyBudWxsIDogc3RyaW5nLmFzc2lnbihsYW5nLmdldCgndHlwZScsICdhcnJheScpLCBhbGlhcywgcGFyYW0wKSk7XG5cbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoL14tP1xcZCskLy50ZXN0KHZhbCkgPyBudWxsIDogc3RyaW5nLmFzc2lnbihsYW5nLmdldCgndHlwZScsICdudW1iZXInKSwgYWxpYXMsIHBhcmFtMCkpO1xuICAgICAgICAgICAgY2FzZSAnZGVjaW1hbCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoL15cXGQqXFwuP1xcZCokLy50ZXN0KHZhbCkgPyBudWxsIDogc3RyaW5nLmFzc2lnbihsYW5nLmdldCgndHlwZScsICdudW1iZXInKSwgYWxpYXMsIHBhcmFtMCkpO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyX3Bvc2l0aXZlJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgvXlxcZCsoXFwuXFxkezEsM30pPyQvLnRlc3QodmFsKSA/IG51bGwgOiBzdHJpbmcuYXNzaWduKGxhbmcuZ2V0KCd0eXBlJywgJ251bWJlcicpLCBhbGlhcywgcGFyYW0wKSk7XG4gICAgICAgICAgICBjYXNlICdpbnRlZ2VyJzpcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsID0gdmFsLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5yZXBsYWNlKC9eLS8sICcnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgvXigwfFsxLTldXFxkKikkLy50ZXN0KHZhbCkgPyBudWxsIDogc3RyaW5nLmFzc2lnbihsYW5nLmdldCgndHlwZScsICdpbnRlZ2VyJyksIGFsaWFzLCBwYXJhbTApKTtcblxuICAgICAgICAgICAgY2FzZSAnbW9iaWxlJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgvXjFcXGR7MTB9JC8udGVzdCh2YWwpID8gbnVsbCA6IHN0cmluZy5hc3NpZ24obGFuZy5nZXQoJ3R5cGUnLCAnbW9iaWxlJyksIGFsaWFzLCBwYXJhbTApKTtcblxuICAgICAgICAgICAgY2FzZSAnZW1haWwnOlxuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKHR5cGVpcy5lbWFpbCh2YWwpID8gbnVsbCA6IHN0cmluZy5hc3NpZ24obGFuZy5nZXQoJ3R5cGUnLCAnZW1haWwnKSwgYWxpYXMsIHBhcmFtMCkpO1xuXG4gICAgICAgICAgICBjYXNlICd1cmwnOlxuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKHR5cGVpcy51cmwodmFsKSA/IG51bGwgOiBzdHJpbmcuYXNzaWduKGxhbmcuZ2V0KCd0eXBlJywgJ3VybCcpLCBhbGlhcywgcGFyYW0wKSk7XG4gICAgICAgICAgICBjYXNlICdkYXRlRE1ZJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSh0eXBlaXMuZGF0ZSh2YWwpID8gbnVsbCA6IHN0cmluZy5hc3NpZ24obGFuZy5nZXQoJ3R5cGUnLCAnZGF0ZScpLCBhbGlhcywgcGFyYW0wKSk7XG4gICAgICAgICAgICBjYXNlICdkYXRlWU1EJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSh0eXBlaXMuZGF0ZSh2YWwsIHRydWUpID8gbnVsbCA6IHN0cmluZy5hc3NpZ24obGFuZy5nZXQoJ3R5cGUnLCAnZGF0ZScpLCBhbGlhcywgcGFyYW0wKSk7XG4gICAgICAgICAgICBjYXNlICdkYXRlRE1ZSG0nOlxuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKHR5cGVpcy5kYXRlVGltZVRvTWludXRlKHZhbCkgPyBudWxsIDogc3RyaW5nLmFzc2lnbihsYW5nLmdldCgndHlwZScsICdkYXRlJyksIGFsaWFzLCBwYXJhbTApKTtcbiAgICAgICAgICAgIGNhc2UgJ2RhdGVZTURIbSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUodHlwZWlzLmRhdGVUaW1lVG9NaW51dGUodmFsLCB0cnVlKSA/IG51bGwgOiBzdHJpbmcuYXNzaWduKGxhbmcuZ2V0KCd0eXBlJywgJ2RhdGUnKSwgYWxpYXMsIHBhcmFtMCkpO1xuICAgICAgICAgICAgY2FzZSAnbnVtcmVpY0FsbG93WmVybyc6XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbCA9IHZhbC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgvXlswLTldKiQvLnRlc3QodmFsKSA/IG51bGwgOiBzdHJpbmcuYXNzaWduKGxhbmcuZ2V0KCd0eXBlJywgJ251bXJlaWNBbGxvd1plcm8nKSwgYWxpYXMsIHBhcmFtMCkpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgfSk7XG5cblxuICAgIFZhbGlkYXRpb24uYWRkUnVsZSgncmVxdWlyZWQnLCBmdW5jdGlvbiAodmFsLCBkb25lLCBwYXJhbTApIHtcbiAgICAgICAgaWYgKCFwYXJhbTApIHtcbiAgICAgICAgICAgIHJldHVybiBkb25lKCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGNvbnZlcnRWYWwgPSAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpPyB2YWwudG9TdHJpbmcoKSA6IHZhbDtcbiAgICAgICAgdmFyIGlzTXVsdGlwbGUgPSBfaXNNdWx0aXBsZShjb252ZXJ0VmFsKTtcbiAgICAgICAgdmFyIGJvb2xlYW4gPSB0eXBlaXMoY29udmVydFZhbCkgPT09ICdmaWxlJyA/IHRydWUgOlxuICAgICAgICAgICAgKGlzTXVsdGlwbGUgPyBjb252ZXJ0VmFsIDogKGNvbnZlcnRWYWwgfHwgJycpKS5sZW5ndGggPiAwO1xuICAgICAgICAvL2RvbmUoYm9vbGVhbiA/IG51bGwgOiAnJHtwYXRofeS4jeiDveS4uuepuicpO1xuICAgICAgICBkb25lKGJvb2xlYW4gPyBudWxsIDogbGFuZy5nZXQoJ3JlcXVpcmVkJykpO1xuICAgIH0pO1xuXG5cbiAgICB2YXIgX2NyZWF0ZUxlbmd0aCA9IGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgICAgIHZhciB0eXBlTWFwID0ge1xuICAgICAgICAgICAgMDogJ21pbkxlbmd0aCcsXG4gICAgICAgICAgICAxOiAnbWF4TGVuZ3RoJ1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsLCBkb25lLCBwYXJhbTApIHtcbiAgICAgICAgICAgIHBhcmFtMCA9IG51bWJlci5wYXJzZUludChwYXJhbTApO1xuICAgICAgICAgICAgdmFyIGNvbnZlcnRWYWwgPSAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpID8gdmFsLnRvU3RyaW5nKCkgOiB2YWw7XG4gICAgICAgICAgICB2YXIgcmVxdWlyZWRQYXJhbXMgPSB0aGlzLmdldFJ1bGVQYXJhbXModGhpcy5wYXRoLCAncmVxdWlyZWQnKTtcbiAgICAgICAgICAgIHZhciByZXF1aXJlZCA9IHJlcXVpcmVkUGFyYW1zID8gcmVxdWlyZWRQYXJhbXNbMF0gOiB0cnVlO1xuICAgICAgICAgICAgdmFyIGlzTXVsdGlwbGUgPSBfaXNNdWx0aXBsZShjb252ZXJ0VmFsKTtcbiAgICAgICAgICAgIHZhciBsZW5ndGggPSAoaXNNdWx0aXBsZSA/IGNvbnZlcnRWYWwgOiAoY29udmVydFZhbCB8fCAnJykpLmxlbmd0aDtcbiAgICAgICAgICAgIHZhciBib29sZWFuID0gdHlwZSA9PT0gMCA/IGxlbmd0aCA+PSBwYXJhbTAgOiBsZW5ndGggPD0gcGFyYW0wO1xuXG4gICAgICAgICAgICAvLyDmnKrloasgJiYg5Y+v6YCJXG4gICAgICAgICAgICBpZiAoIWxlbmd0aCAmJiAhcmVxdWlyZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaXNNdWx0aXBsZSkge1xuICAgICAgICAgICAgICAgIGRvbmUoYm9vbGVhbiA/IG51bGwgOiBsYW5nLmdldCh0eXBlTWFwW3R5cGVdLCAnc2VsZWN0JykpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBkb25lKGJvb2xlYW4gPyBudWxsIDogbGFuZy5nZXQodHlwZU1hcFt0eXBlXSwgJ2lucHV0JykpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH07XG5cbiAgICBWYWxpZGF0aW9uLmFkZFJ1bGUoJ21pbkxlbmd0aCcsIF9jcmVhdGVMZW5ndGgoMCkpO1xuICAgIFZhbGlkYXRpb24uYWRkUnVsZSgnbWF4TGVuZ3RoJywgX2NyZWF0ZUxlbmd0aCgxKSk7XG5cblxuICAgIFZhbGlkYXRpb24uYWRkUnVsZSgnZXF1YWwnLCBmdW5jdGlvbiAodmFsLCBkb25lLCBwYXJhbTApIHtcbiAgICAgICAgdmFsID0gdmFsIHx8ICcnO1xuICAgICAgICBkb25lKHZhbCA9PT0gdGhpcy5nZXREYXRhKHBhcmFtMCkgPyBudWxsIDogJyR7MX3lv4XpobvkuI4nICsgdGhpcy5nZXRBbGlhcyhwYXJhbTApICsgJ+ebuOWQjCcpO1xuICAgIH0pO1xuXG5cbiAgICB2YXIgX2NyZWF0ZU51bWJlciA9IGZ1bmN0aW9uICh0eXBlKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAodmFsLCBkb25lLCBwYXJhbTApIHtcbiAgICAgICAgICAgIHZhbCA9IHZhbCB8fCAnJztcblxuICAgICAgICAgICAgdmFyIGlzUmVxdWlyZWQgPSB0aGlzLmdldFJ1bGVQYXJhbXModGhpcy5wYXRoLCAncmVxdWlyZWQnKTtcbiAgICAgICAgICAgIGlzUmVxdWlyZWQgPSBpc1JlcXVpcmVkID8gaXNSZXF1aXJlZFswXSA6IHRydWU7XG4gICAgICAgICAgICAvLyDpnZ7lv4XloavlubbkuJTmmK/nqbrlgLxcbiAgICAgICAgICAgIGlmICghaXNSZXF1aXJlZCAmJiAodmFsID09IFwiXCIgfHwgdmFsID09IG51bGwgfHwgdHlwZW9mIHZhbCA9PSBcInVuZGVmaW5lZFwiKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkb25lKG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIVJFR19OVU1CRVJJQy50ZXN0KHZhbCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgnJHsxfeW/hemhu+S4uuaVsOWAvOagvOW8jycpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YWwgPSBudW1iZXIucGFyc2VGbG9hdCh2YWwpO1xuICAgICAgICAgICAgcGFyYW0wID0gbnVtYmVyLnBhcnNlRmxvYXQocGFyYW0wKTtcblxuICAgICAgICAgICAgdmFyIGJvb2xlYW4gPSB0eXBlID09PSAwID8gdmFsID49IHBhcmFtMCA6IHZhbCA8PSBwYXJhbTA7XG5cbiAgICAgICAgICAgIGRvbmUoYm9vbGVhbiA/IG51bGwgOiBsYW5nLmdldCh0eXBlID8gJ21heCcgOiAnbWluJykpO1xuICAgICAgICB9O1xuICAgIH07XG5cbiAgICBWYWxpZGF0aW9uLmFkZFJ1bGUoJ21pbicsIF9jcmVhdGVOdW1iZXIoMCkpO1xuICAgIFZhbGlkYXRpb24uYWRkUnVsZSgnbWF4JywgX2NyZWF0ZU51bWJlcigxKSk7XG4gICAgVmFsaWRhdGlvbi5hZGRSdWxlKCdzdGVwJywgZnVuY3Rpb24gKHZhbCwgZG9uZSwgcGFyYW0wKSB7XG4gICAgICAgIHZhbCA9IHZhbCB8fCAnJztcblxuICAgICAgICB2YXIgaXNSZXF1aXJlZCA9IHRoaXMuZ2V0UnVsZVBhcmFtcyh0aGlzLnBhdGgsICdyZXF1aXJlZCcpO1xuXG4gICAgICAgIC8vIOmdnuW/heWhq+W5tuS4lOaYr+epuuWAvFxuICAgICAgICBpZiAoIWlzUmVxdWlyZWQgJiYgIXZhbCkge1xuICAgICAgICAgICAgcmV0dXJuIGRvbmUobnVsbCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIVJFR19OVU1CRVJJQy50ZXN0KHZhbCkpIHtcbiAgICAgICAgICAgIHJldHVybiBkb25lKCckezF95b+F6aG75Li65pWw5YC85qC85byPJyk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgbWluID0gdGhpcy5nZXRSdWxlUGFyYW1zKHRoaXMucGF0aCwgJ21pbicpWzBdO1xuXG4gICAgICAgIHZhbCA9IG51bWJlci5wYXJzZUludCh2YWwsIDApO1xuICAgICAgICBwYXJhbTAgPSBudW1iZXIucGFyc2VJbnQocGFyYW0wLCAwKTtcblxuICAgICAgICBpZiAoIXBhcmFtMCkge1xuICAgICAgICAgICAgcmV0dXJuIGRvbmUobnVsbCk7XG4gICAgICAgIH1cblxuICAgICAgICBkb25lKCh2YWwgLSBtaW4pICUgcGFyYW0wID8gJyR7MX3pgJLlop7mraXov5vlgLzlv4XpobvmmK8nICsgcGFyYW0wICsgJ++8jOacgOWwj+WAvOS4uicgKyBtaW4gOiBudWxsKTtcbiAgICB9KTtcblxuICAgIHZhciBfY3JlYXRlU2VsZWN0ID0gZnVuY3Rpb24gKHR5cGUpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh2YWwsIGRvbmUsIHBhcmFtMCkge1xuICAgICAgICAgICAgaWYgKCFwYXJhbTApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodHlwZWlzKHZhbCkgIT09ICdhcnJheScpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZSgnJHsxfeW/hemhu+S4uuaVsOe7hOagvOW8jycpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgbGVuZ3RoID0gdmFsLmxlbmd0aDtcblxuICAgICAgICAgICAgLy8gbW9zdFxuICAgICAgICAgICAgaWYgKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBkb25lKGxlbmd0aCA+IHBhcmFtMCA/IGxhbmcuZ2V0KCdtb3N0JykgOiBudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGxlYXN0XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBkb25lKGxlbmd0aCA8IHBhcmFtMCA/IGxhbmcuZ2V0KCdsZWFzdCcpIDogbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIFZhbGlkYXRpb24uYWRkUnVsZSgnbGVhc3QnLCBfY3JlYXRlU2VsZWN0KDApKTtcbiAgICBWYWxpZGF0aW9uLmFkZFJ1bGUoJ21vc3QnLCBfY3JlYXRlU2VsZWN0KDEpKTtcbn07XG5cblxuLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG4vKipcbiAqIOWIpOaWreaYr+WQpuS4uuWkmuWAvOexu+Wei1xuICogQHBhcmFtIG9ialxuICogQHJldHVybnMge2Jvb2xlYW59XG4gKi9cbmZ1bmN0aW9uIF9pc011bHRpcGxlKG9iaikge1xuICAgIHJldHVybiB0eXBlaXMuYXJyYXkob2JqKSB8fCB0eXBlaXMob2JqKSA9PT0gJ2ZpbGVsaXN0Jztcbn1cbiJdfQ==