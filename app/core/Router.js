"use strict";

var _EmployeeService = require("../services/EmployeeService");

var _EmployeeService2 = _interopRequireDefault(_EmployeeService);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var url = require("url");
var querystring = require("querystring");
var fs = require('fs');
var getProtocol = function getProtocol(req) {
	var proto = req.connection.encrypted ? 'https' : 'http';
	proto = req.headers['x-forwarded-proto'] || proto;
	return proto.split(/\s*,\s*/)[0];
};

function route(req, resp) {

	i18n.setLocale(config.i18n.defaultLocale);
	var curUrl = url.parse(req.url);
	var pathname = curUrl.pathname.replace(config.server.context_path + "/", "");

	var public_path_idx = config.server.public_path.indexOf(pathname);
	var query = curUrl.query;
	var protocol = getProtocol(req);
	var pathSplit = pathname.split("/");
	var host = Libs.toLowerCase(req.hostname);
	if (req.headers.origin) {
		host = req.headers.origin.replace(/(^\w+:|^)\/\//, '');
	}
	host = host.replace(/[:]{1}\d*/, '');
	var hostPartLength = (host.match(/\./g) || []).length;
	var referDomain = host;
	if (hostPartLength >= 2) {
		referDomain = host.replace(new RegExp('^[a-z0-9]*\.'), '');
	}
	/** check domain cho phep truy cap*/
	if (public_path_idx < 0 && (!config.server.domain || config.server.domain.indexOf(referDomain) < 0) && req.hostname != host) {
		resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
		return;
	}

	var splitHost = host.match(new RegExp('^[a-z0-9]*\.'));
	if (!splitHost || splitHost.length < 0) {
		resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
		return;
	}
	var subHost = splitHost[0].replace('.', '');
	if (Libs.isBlank(pathSplit[1])) {
		// pathSplit[1] = defaultController;
		log.info("No request function found for " + method);
		resp.writeHead(404, {
			"Content-Type": "text/plain"
		});
		resp.write("404 request handler Not found");
		resp.end();
		return;
	}

	var handleRequest = function handleRequest(req, resp, handle, method) {
		try {
			if (typeof handle[method] === 'function') {
				var postData = "";
				req.addListener("data", function (postDataChunk) {
					postData += postDataChunk;
				});
				req.addListener("end", async function () {
					var data = {};
					var isJson = true;
					try {
						data = JSON.parse(postData);
					} catch (e) {
						isJson = false;
						log.error(e);
					}

					if (!isJson) {
						if (!Libs.isBlank(query)) {
							postData = query + "&" + postData;
						}
						data = querystring.parse(postData);
					}
					var token = req.headers['x-access-token'];
					var userE = Libs.decodeTokenCrypto(token);
					if (null != userE) {
						try {

							var employee = new _EmployeeService2.default();
							userE.permissions = await employee.getCachePermission(userE);

							var expiresTime = userE['expiresTime'];
							var now = new Date().getTime();
							if (now > expiresTime) {
								resp.writeHead(401, {
									"Content-Type": "text/plain"
								});
								resp.end();
							}
							handle.userE = userE;
							data.currentUser = userE.email;
						} catch (e) {
							console.log(e);
						}
					}
					handle.headers = req.headers;
					handle.baseUrl = protocol + "://" + req.headers.host;
					if (config.server.context_path) {
						handle.baseUrl += "/" + config.server.context_path;
					}

					data.action = method;
					data.lang = i18n.getLocale();
					data.lang_default = i18n.getLocale();
					if (typeof req.headers.lang != 'undefined' && req.headers.lang != '') {
						data.lang = req.headers.lang;
						i18n.setLocale(req.headers.lang);
					}

					if (!Libs.isInArray(pathname, Constants.public_api) && public_path_idx < 0) {
						// if(pathname !== Constants.public_api.login && public_path_idx < 0){
						var pathReferer = route.checkPathReferer(req);

						handle.pathReferer = pathReferer;

						if (!pathReferer) {
							// console.log("thêm 'req_path' vào header");
							resp.status(511).send(Libs.returnJsonResult(false, i18n.__('AUTH_REQUIRE'), {}, 0));
							return;
						}
						if (typeof handle['checkPermission'] === 'function') {
							var auth = handle['checkPermission'](Constants.auth_mode.VIEW);
							if (!auth) {
								resp.status(401).send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
								return;
							}
						}
						if (typeof handle['checkPermissions'] === 'function') {
							var _auth = handle['checkPermissions'](method, data);
							if (!_auth) {
								resp.send(Libs.returnJsonResult(false, i18n.__('AUTH_FALSE'), {}, 0));
								return;
							}
						}
					}
					if (userE) {
						var logE = Object.assign({}, data);
						logE.key = userE.email;
						logE.event_time = Libs.getCurrentDateFormat('yyyyMMddHHmmss');
						event.emit('log', Constants.type_log.request, { table_name: null, content: logE });
					}
					handle[method](resp, data);
				});
			} else {
				log.info("No request function found for " + method);
				resp.writeHead(404, {
					"Content-Type": "text/plain"
				});
				resp.write("404 request handler Not found");
				resp.end();
			}
		} catch (e) {
			console.log(e);
		}
	};
	var controller = Libs.capitalize(pathSplit[1]) + "Controller";
	var handle = null;
	if (Libs.checkFileExits(controlPath, controller + '.js')) {

		var cls = require(controlPath + controller);
		handle = new cls['default']();
		if (Libs.isBlank(pathSplit[2])) {
			// pathSplit[2] = defaultFunction;
			log.info("No request function found for " + method);
			resp.writeHead(404, {
				"Content-Type": "text/plain"
			});
			resp.write("404 request handler Not found");
			resp.end();
			return;
		}
		var method = pathSplit[2];
		handleRequest(req, resp, handle, method);
	} else {
		var rQCtrName = controller.toLowerCase() + '.js';
		var files = fs.readdirSync(controlPath);
		var controllerNew = null;
		files.forEach(function (file) {
			var lowerFileName = file.toLowerCase();
			if (lowerFileName === rQCtrName) {
				controllerNew = file;
				return true;
			}
		});
		if (controllerNew != null) {
			var cls = require(controlPath + controllerNew);
			handle = new cls['default']();
			if (Libs.isBlank(pathSplit[2])) {
				// pathSplit[2] = defaultFunction;
				log.info("No request function found for " + method);
				resp.writeHead(404, {
					"Content-Type": "text/plain"
				});
				resp.write("404 request handler Not found");
				resp.end();
				return;
			}
			var method = pathSplit[2];
			// var method = action;
			handleRequest(req, resp, handle, method);
		} else {
			log.info("No request file found for " + pathname);
			resp.writeHead(404, {
				"Content-Type": "text/plain"
			});
			resp.write("404 request handler Not found");
			resp.end();
		}
	}
}

route.checkPathReferer = function (req) {
	try {
		var req_path = req.headers['req-path'];
		var referer = false;
		var pathReferer = false;
		if (req_path) {
			referer = req_path;
		} else {
			referer = req.headers.referer;
		}
		if (referer) {
			pathReferer = url.parse(referer, false).pathname;
		}
		return pathReferer;
	} catch (ex) {
		console.log("checkPathReferer error:", ex);
		return null;
	}
};
exports.route = route;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL1JvdXRlci5qcyJdLCJuYW1lcyI6WyJ1cmwiLCJyZXF1aXJlIiwicXVlcnlzdHJpbmciLCJmcyIsImdldFByb3RvY29sIiwicmVxIiwicHJvdG8iLCJjb25uZWN0aW9uIiwiZW5jcnlwdGVkIiwiaGVhZGVycyIsInNwbGl0Iiwicm91dGUiLCJyZXNwIiwiaTE4biIsInNldExvY2FsZSIsImNvbmZpZyIsImRlZmF1bHRMb2NhbGUiLCJjdXJVcmwiLCJwYXJzZSIsInBhdGhuYW1lIiwicmVwbGFjZSIsInNlcnZlciIsImNvbnRleHRfcGF0aCIsInB1YmxpY19wYXRoX2lkeCIsInB1YmxpY19wYXRoIiwiaW5kZXhPZiIsInF1ZXJ5IiwicHJvdG9jb2wiLCJwYXRoU3BsaXQiLCJob3N0IiwiTGlicyIsInRvTG93ZXJDYXNlIiwiaG9zdG5hbWUiLCJvcmlnaW4iLCJob3N0UGFydExlbmd0aCIsIm1hdGNoIiwibGVuZ3RoIiwicmVmZXJEb21haW4iLCJSZWdFeHAiLCJkb21haW4iLCJzdGF0dXMiLCJzZW5kIiwicmV0dXJuSnNvblJlc3VsdCIsIl9fIiwic3BsaXRIb3N0Iiwic3ViSG9zdCIsImlzQmxhbmsiLCJsb2ciLCJpbmZvIiwibWV0aG9kIiwid3JpdGVIZWFkIiwid3JpdGUiLCJlbmQiLCJoYW5kbGVSZXF1ZXN0IiwiaGFuZGxlIiwicG9zdERhdGEiLCJhZGRMaXN0ZW5lciIsInBvc3REYXRhQ2h1bmsiLCJkYXRhIiwiaXNKc29uIiwiSlNPTiIsImUiLCJlcnJvciIsInRva2VuIiwidXNlckUiLCJkZWNvZGVUb2tlbkNyeXB0byIsImVtcGxveWVlIiwiRW1wbG95ZWVTZXJ2aWNlIiwicGVybWlzc2lvbnMiLCJnZXRDYWNoZVBlcm1pc3Npb24iLCJleHBpcmVzVGltZSIsIm5vdyIsIkRhdGUiLCJnZXRUaW1lIiwiY3VycmVudFVzZXIiLCJlbWFpbCIsImNvbnNvbGUiLCJiYXNlVXJsIiwiYWN0aW9uIiwibGFuZyIsImdldExvY2FsZSIsImxhbmdfZGVmYXVsdCIsImlzSW5BcnJheSIsIkNvbnN0YW50cyIsInB1YmxpY19hcGkiLCJwYXRoUmVmZXJlciIsImNoZWNrUGF0aFJlZmVyZXIiLCJhdXRoIiwiYXV0aF9tb2RlIiwiVklFVyIsImxvZ0UiLCJPYmplY3QiLCJhc3NpZ24iLCJrZXkiLCJldmVudF90aW1lIiwiZ2V0Q3VycmVudERhdGVGb3JtYXQiLCJldmVudCIsImVtaXQiLCJ0eXBlX2xvZyIsInJlcXVlc3QiLCJ0YWJsZV9uYW1lIiwiY29udGVudCIsImNvbnRyb2xsZXIiLCJjYXBpdGFsaXplIiwiY2hlY2tGaWxlRXhpdHMiLCJjb250cm9sUGF0aCIsImNscyIsInJRQ3RyTmFtZSIsImZpbGVzIiwicmVhZGRpclN5bmMiLCJjb250cm9sbGVyTmV3IiwiZm9yRWFjaCIsImxvd2VyRmlsZU5hbWUiLCJmaWxlIiwicmVxX3BhdGgiLCJyZWZlcmVyIiwiZXgiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQVFBOzs7Ozs7QUFSQSxJQUFJQSxNQUFNQyxRQUFRLEtBQVIsQ0FBVjtBQUNBLElBQUlDLGNBQWNELFFBQVEsYUFBUixDQUFsQjtBQUNBLElBQUlFLEtBQUtGLFFBQVEsSUFBUixDQUFUO0FBQ0EsSUFBTUcsY0FBYyxTQUFkQSxXQUFjLENBQVVDLEdBQVYsRUFBZTtBQUNsQyxLQUFJQyxRQUFRRCxJQUFJRSxVQUFKLENBQWVDLFNBQWYsR0FBMkIsT0FBM0IsR0FBcUMsTUFBakQ7QUFDQUYsU0FBUUQsSUFBSUksT0FBSixDQUFZLG1CQUFaLEtBQW9DSCxLQUE1QztBQUNBLFFBQU9BLE1BQU1JLEtBQU4sQ0FBWSxTQUFaLEVBQXVCLENBQXZCLENBQVA7QUFDQSxDQUpEOztBQU1BLFNBQVNDLEtBQVQsQ0FBZU4sR0FBZixFQUFvQk8sSUFBcEIsRUFBMEI7O0FBRXpCQyxNQUFLQyxTQUFMLENBQWVDLE9BQU9GLElBQVAsQ0FBWUcsYUFBM0I7QUFDQSxLQUFJQyxTQUFTakIsSUFBSWtCLEtBQUosQ0FBVWIsSUFBSUwsR0FBZCxD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eUIsVUFBQ2pGLEdBQUQsRUFBUTtBQUNoQyxLQUFHO0FBQ0YsTUFBSTZHLFdBQVc3RyxJQUFJSSxPQUFKLENBQVksVUFBWixDQUFmO0FBQ0EsTUFBSTBHLFVBQVUsS0FBZDtBQUNBLE1BQUk5QixjQUFjLEtBQWxCO0FBQ0EsTUFBRzZCLFFBQUgsRUFBWTtBQUNYQyxhQUFVRCxRQUFWO0FBQ0EsR0FGRCxNQUVLO0FBQ0pDLGFBQVU5RyxJQUFJSSxPQUFKLENBQVkwRyxPQUF0QjtBQUNBO0FBQ0QsTUFBR0EsT0FBSCxFQUFXO0FBQ1Y5QixpQkFBY3JGLElBQUlrQixLQUFKLENBQVVpRyxPQUFWLEVBQW1CLEtBQW5CLEVBQTBCaEcsUUFBeEM7QUFDQTtBQUNELFNBQU9rRSxXQUFQO0FBQ0EsRUFiRCxDQWFDLE9BQU0rQixFQUFOLEVBQVM7QUFDVHhDLFVBQVE3QixHQUFSLENBQVkseUJBQVosRUFBdUNxRSxFQUF2QztBQUNBLFNBQU8sSUFBUDtBQUNBO0FBRUQsQ0FuQkQ7QUFvQkFDLFFBQVExRyxLQUFSLEdBQWdCQSxLQUFoQiIsImZpbGUiOiJSb3V0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgdXJsID0gcmVxdWlyZShcInVybFwiKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBnZXRQcm90b2NvbCA9IGZ1bmN0aW9uIChyZXEpIHtcblx0dmFyIHByb3RvID0gcmVxLmNvbm5lY3Rpb24uZW5jcnlwdGVkID8gJ2h0dHBzJyA6ICdodHRwJztcblx0cHJvdG8gPSByZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtcHJvdG8nXSB8fCBwcm90bztcblx0cmV0dXJuIHByb3RvLnNwbGl0KC9cXHMqLFxccyovKVswXTtcbn1cbmltcG9ydCBFbXBsb3llZVNlcnZpY2UgZnJvbSAnLi4vc2VydmljZXMvRW1wbG95ZWVTZXJ2aWNlJztcbmZ1bmN0aW9uIHJvdXRlKHJlcSwgcmVzcCkge1xuXG5cdGkxOG4uc2V0TG9jYWxlKGNvbmZpZy5pMThuLmRlZmF1bHRMb2NhbGUpO1xuXHR2YXIgY3VyVXJsID0gdXJsLnBhcnNlKHJlcS51cmwpO1xuXHR2YXIgcGF0aG5hbWUgPSBjdXJVcmwucGF0aG5hbWUucmVwbGFjZShjb25maWcuc2VydmVyLmNvbnRleHRfcGF0aCtcIi9cIixcIlwiKTtcblxuXHRsZXQgcHVibGljX3BhdGhfaWR4ID0gY29uZmlnLnNlcnZlci5wdWJsaWNfcGF0aC5pbmRleE9mKHBhdGhuYW1lKTtcblx0dmFyIHF1ZXJ5ID0gY3VyVXJsLnF1ZXJ5O1xuXHR2YXIgcHJvdG9jb2wgPSBnZXRQcm90b2NvbChyZXEpXG5cdHZhciBwYXRoU3BsaXQgPSBwYXRobmFtZS5zcGxpdChcIi9cIik7XG5cdGxldCBob3N0ID0gTGlicy50b0xvd2VyQ2FzZShyZXEuaG9zdG5hbWUpO1xuXHRpZihyZXEuaGVhZGVycy5vcmlnaW4pe1xuXHRcdGhvc3QgPSByZXEuaGVhZGVycy5vcmlnaW4ucmVwbGFjZSgvKF5cXHcrOnxeKVxcL1xcLy8sICcnKTtcblx0fVxuXHRob3N0ID0gaG9zdC5yZXBsYWNlKC9bOl17MX1cXGQqLywnJyk7XG5cdGxldCBob3N0UGFydExlbmd0aCA9IChob3N0Lm1hdGNoKC9cXC4vZykgfHwgW10pLmxlbmd0aDtcblx0bGV0IHJlZmVyRG9tYWluID0gaG9zdDtcblx0aWYoaG9zdFBhcnRMZW5ndGg+PTIpe1xuXHRcdHJlZmVyRG9tYWluID0gaG9zdC5yZXBsYWNlKG5ldyBSZWdFeHAoJ15bYS16MC05XSpcXC4nKSwnJyk7XG5cdH1cblx0LyoqIGNoZWNrIGRvbWFpbiBjaG8gcGhlcCB0cnV5IGNhcCovXG5cdGlmKHB1YmxpY19wYXRoX2lkeDwwICYmICggIWNvbmZpZy5zZXJ2ZXIuZG9tYWluIHx8IGNvbmZpZy5zZXJ2ZXIuZG9tYWluLmluZGV4T2YocmVmZXJEb21haW4pPDApICYmIChyZXEuaG9zdG5hbWUgIT0gaG9zdCkpe1xuXHRcdHJlc3Auc3RhdHVzKDQwMSkuc2VuZChMaWJzLnJldHVybkpzb25SZXN1bHQoZmFsc2UsIGkxOG4uX18oJ0FVVEhfRkFMU0UnKSwge30sIDApKTtcblx0XHRyZXR1cm47XG5cdH1cblxuXHRsZXQgc3BsaXRIb3N0ID0gaG9zdC5tYXRjaChuZXcgUmVnRXhwKCdeW2EtejAtOV0qXFwuJykpO1xuXHRpZighc3BsaXRIb3N0IHx8IHNwbGl0SG9zdC5sZW5ndGggPDApe1xuXHRcdHJlc3Auc3RhdHVzKDQwMSkuc2VuZChMaWJzLnJldHVybkpzb25SZXN1bHQoZmFsc2UsIGkxOG4uX18oJ0FVVEhfRkFMU0UnKSwge30sIDApKTtcblx0XHRyZXR1cm47XG5cdH1cblx0bGV0IHN1Ykhvc3QgPSBzcGxpdEhvc3RbMF0ucmVwbGFjZSgnLicsICcnKSA7XG5cdGlmIChMaWJzLmlzQmxhbmsocGF0aFNwbGl0WzFdKSkge1xuXHRcdC8vIHBhdGhTcGxpdFsxXSA9IGRlZmF1bHRDb250cm9sbGVyO1xuXHRcdGxvZy5pbmZvKFwiTm8gcmVxdWVzdCBmdW5jdGlvbiBmb3VuZCBmb3IgXCIgKyBtZXRob2QpO1xuXHRcdHJlc3Aud3JpdGVIZWFkKDQwNCwge1xuXHRcdFx0XCJDb250ZW50LVR5cGVcIjogXCJ0ZXh0L3BsYWluXCJcblx0XHR9KTtcblx0XHRyZXNwLndyaXRlKFwiNDA0IHJlcXVlc3QgaGFuZGxlciBOb3QgZm91bmRcIik7XG5cdFx0cmVzcC5lbmQoKTtcblx0XHRyZXR1cm47XG5cdH1cblx0XG5cblx0dmFyIGhhbmRsZVJlcXVlc3QgPSBmdW5jdGlvbiAocmVxLCByZXNwLCBoYW5kbGUsIG1ldGhvZCkge1xuXHRcdHRyeSB7XG5cdFx0XHRpZiAodHlwZW9mIGhhbmRsZVttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdHZhciBwb3N0RGF0YSA9IFwiXCI7XG5cdFx0XHRcdHJlcS5hZGRMaXN0ZW5lcihcImRhdGFcIiwgZnVuY3Rpb24gKHBvc3REYXRhQ2h1bmspIHtcblx0XHRcdFx0XHRwb3N0RGF0YSArPSBwb3N0RGF0YUNodW5rO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0cmVxLmFkZExpc3RlbmVyKFwiZW5kXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHR2YXIgZGF0YSA9IHt9O1xuXHRcdFx0XHRcdHZhciBpc0pzb24gPSB0cnVlO1xuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRkYXRhID0gSlNPTi5wYXJzZShwb3N0RGF0YSk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRcdFx0aXNKc29uID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRsb2cuZXJyb3IoZSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKCFpc0pzb24pIHtcblx0XHRcdFx0XHRcdGlmICghTGlicy5pc0JsYW5rKHF1ZXJ5KSkge1xuXHRcdFx0XHRcdFx0XHRwb3N0RGF0YSA9IHF1ZXJ5ICsgXCImXCIgKyBwb3N0RGF0YTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGRhdGEgPSBxdWVyeXN0cmluZy5wYXJzZShwb3N0RGF0YSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGxldCB0b2tlbiA9IHJlcS5oZWFkZXJzWyd4LWFjY2Vzcy10b2tlbiddO1xuXHRcdFx0XHRcdGxldCB1c2VyRSA9IExpYnMuZGVjb2RlVG9rZW5DcnlwdG8odG9rZW4pO1xuXHRcdFx0XHRcdGlmIChudWxsICE9IHVzZXJFKSB7XG5cdFx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdFx0bGV0IGVtcGxveWVlID0gbmV3IEVtcGxveWVlU2VydmljZSgpO1xuXHRcdFx0XHRcdFx0XHR1c2VyRS5wZXJtaXNzaW9ucyA9IGF3YWl0IGVtcGxveWVlLmdldENhY2hlUGVybWlzc2lvbih1c2VyRSk7XG5cblxuXHRcdFx0XHRcdFx0XHRsZXQgZXhwaXJlc1RpbWUgPSB1c2VyRVsnZXhwaXJlc1RpbWUnXTtcblx0XHRcdFx0XHRcdFx0bGV0IG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXHRcdFx0XHRcdFx0XHRpZiAobm93ID4gZXhwaXJlc1RpbWUpIHtcblx0XHRcdFx0XHRcdFx0XHRyZXNwLndyaXRlSGVhZCg0MDEsIHtcblx0XHRcdFx0XHRcdFx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpblwiXG5cdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0cmVzcC5lbmQoKTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRoYW5kbGUudXNlckUgPSB1c2VyRTtcblx0XHRcdFx0XHRcdFx0ZGF0YS5jdXJyZW50VXNlciA9IHVzZXJFLmVtYWlsO1xuXHRcdFx0XHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRoYW5kbGUuaGVhZGVycyA9IHJlcS5oZWFkZXJzO1xuXHRcdFx0XHRcdGhhbmRsZS5iYXNlVXJsID0gcHJvdG9jb2wrXCI6Ly9cIiArIHJlcS5oZWFkZXJzLmhvc3Q7XG5cdFx0XHRcdFx0aWYoY29uZmlnLnNlcnZlci5jb250ZXh0X3BhdGgpe1xuXHRcdFx0XHRcdFx0aGFuZGxlLmJhc2VVcmwrPWAvJHtjb25maWcuc2VydmVyLmNvbnRleHRfcGF0aH1gO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGRhdGEuYWN0aW9uID0gbWV0aG9kO1xuXHRcdFx0XHRcdGRhdGEubGFuZyA9IGkxOG4uZ2V0TG9jYWxlKCk7XG5cdFx0XHRcdFx0ZGF0YS5sYW5nX2RlZmF1bHQgPSBpMThuLmdldExvY2FsZSgpO1xuXHRcdFx0XHRcdGlmICh0eXBlb2YgcmVxLmhlYWRlcnMubGFuZyAhPSAndW5kZWZpbmVkJyAmJiByZXEuaGVhZGVycy5sYW5nICE9ICcnKSB7XG5cdFx0XHRcdFx0XHRkYXRhLmxhbmcgPSByZXEuaGVhZGVycy5sYW5nO1xuXHRcdFx0XHRcdFx0aTE4bi5zZXRMb2NhbGUocmVxLmhlYWRlcnMubGFuZyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdGlmKCFMaWJzLmlzSW5BcnJheShwYXRobmFtZSwgQ29uc3RhbnRzLnB1YmxpY19hcGkpICYmIHB1YmxpY19wYXRoX2lkeCA8IDApe1xuXHRcdFx0XHRcdC8vIGlmKHBhdGhuYW1lICE9PSBDb25zdGFudHMucHVibGljX2FwaS5sb2dpbiAmJiBwdWJsaWNfcGF0aF9pZHggPCAwKXtcblx0XHRcdFx0XHRcdGxldCBwYXRoUmVmZXJlciA9IHJvdXRlLmNoZWNrUGF0aFJlZmVyZXIocmVxKTtcblxuXHRcdFx0XHRcdFx0aGFuZGxlLnBhdGhSZWZlcmVyID0gcGF0aFJlZmVyZXI7XG5cdFx0XHRcdFx0XHRcblxuXHRcdFx0XHRcdFx0aWYoIXBhdGhSZWZlcmVyKXtcblx0XHRcdFx0XHRcdFx0Ly8gY29uc29sZS5sb2coXCJ0aMOqbSAncmVxX3BhdGgnIHbDoG8gaGVhZGVyXCIpO1xuXHRcdFx0XHRcdFx0XHRyZXNwLnN0YXR1cyg1MTEpLnNlbmQoTGlicy5yZXR1cm5Kc29uUmVzdWx0KGZhbHNlLCBpMThuLl9fKCdBVVRIX1JFUVVJUkUnKSwge30sIDApKTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0aWYodHlwZW9mIGhhbmRsZVsnY2hlY2tQZXJtaXNzaW9uJ10gPT09ICdmdW5jdGlvbicpe1xuXHRcdFx0XHRcdFx0XHRsZXQgYXV0aCA9IGhhbmRsZVsnY2hlY2tQZXJtaXNzaW9uJ10oQ29uc3RhbnRzLmF1dGhfbW9kZS5WSUVXKTtcblx0XHRcdFx0XHRcdFx0aWYoIWF1dGgpe1xuXHRcdFx0XHRcdFx0XHRcdHJlc3Auc3RhdHVzKDQwMSkuc2VuZChMaWJzLnJldHVybkpzb25SZXN1bHQoZmFsc2UsIGkxOG4uX18oJ0FVVEhfRkFMU0UnKSwge30sIDApKTtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGlmKHR5cGVvZiBoYW5kbGVbJ2NoZWNrUGVybWlzc2lvbnMnXSA9PT0gJ2Z1bmN0aW9uJyl7XG5cdFx0XHRcdFx0XHRcdGxldCBhdXRoID0gaGFuZGxlWydjaGVja1Blcm1pc3Npb25zJ10obWV0aG9kLCBkYXRhKTtcblx0XHRcdFx0XHRcdFx0aWYoIWF1dGgpe1xuXHRcdFx0XHRcdFx0XHRcdHJlc3Auc2VuZChMaWJzLnJldHVybkpzb25SZXN1bHQoZmFsc2UsIGkxOG4uX18oJ0FVVEhfRkFMU0UnKSwge30sIDApKTtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0gXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGlmKHVzZXJFKXtcblx0XHRcdFx0XHRcdGxldCBsb2dFID0gT2JqZWN0LmFzc2lnbih7fSxkYXRhKTtcblx0XHRcdFx0XHRcdGxvZ0Uua2V5ID0gdXNlckUuZW1haWw7XG5cdFx0XHRcdFx0XHRsb2dFLmV2ZW50X3RpbWUgPSBMaWJzLmdldEN1cnJlbnREYXRlRm9ybWF0KCd5eXl5TU1kZEhIbW1zcycpO1xuXHRcdFx0XHRcdFx0ZXZlbnQuZW1pdCgnbG9nJywgQ29uc3RhbnRzLnR5cGVfbG9nLnJlcXVlc3QsIHt0YWJsZV9uYW1lOiBudWxsLGNvbnRlbnQ6bG9nRX0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRoYW5kbGVbbWV0aG9kXShyZXNwLCBkYXRhKTtcblx0XHRcdFx0fSk7XG5cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxvZy5pbmZvKFwiTm8gcmVxdWVzdCBmdW5jdGlvbiBmb3VuZCBmb3IgXCIgKyBtZXRob2QpO1xuXHRcdFx0XHRyZXNwLndyaXRlSGVhZCg0MDQsIHtcblx0XHRcdFx0XHRcIkNvbnRlbnQtVHlwZVwiOiBcInRleHQvcGxhaW5cIlxuXHRcdFx0XHR9KTtcblx0XHRcdFx0cmVzcC53cml0ZShcIjQwNCByZXF1ZXN0IGhhbmRsZXIgTm90IGZvdW5kXCIpO1xuXHRcdFx0XHRyZXNwLmVuZCgpO1xuXHRcdFx0fVxuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdGNvbnNvbGUubG9nKGUpXG5cdFx0fVxuXHR9O1xuXHR2YXIgY29udHJvbGxlciA9IExpYnMuY2FwaXRhbGl6ZShwYXRoU3BsaXRbMV0pICsgXCJDb250cm9sbGVyXCI7XG5cdHZhciBoYW5kbGUgPSBudWxsO1xuXHRpZiAoTGlicy5jaGVja0ZpbGVFeGl0cyhjb250cm9sUGF0aCwgY29udHJvbGxlciArICcuanMnKSkge1xuXG5cdFx0dmFyIGNscyA9IHJlcXVpcmUoY29udHJvbFBhdGggKyBjb250cm9sbGVyKTtcblx0XHRoYW5kbGUgPSBuZXcgY2xzWydkZWZhdWx0J10oKTtcblx0XHRpZiAoTGlicy5pc0JsYW5rKHBhdGhTcGxpdFsyXSkpIHtcblx0XHRcdC8vIHBhdGhTcGxpdFsyXSA9IGRlZmF1bHRGdW5jdGlvbjtcblx0XHRcdGxvZy5pbmZvKFwiTm8gcmVxdWVzdCBmdW5jdGlvbiBmb3VuZCBmb3IgXCIgKyBtZXRob2QpO1xuXHRcdFx0cmVzcC53cml0ZUhlYWQoNDA0LCB7XG5cdFx0XHRcdFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpblwiXG5cdFx0XHR9KTtcblx0XHRcdHJlc3Aud3JpdGUoXCI0MDQgcmVxdWVzdCBoYW5kbGVyIE5vdCBmb3VuZFwiKTtcblx0XHRcdHJlc3AuZW5kKCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdHZhciBtZXRob2QgPSBwYXRoU3BsaXRbMl07XG5cdFx0aGFuZGxlUmVxdWVzdChyZXEsIHJlc3AsIGhhbmRsZSwgbWV0aG9kKTtcblx0fSBlbHNlIHtcblx0XHR2YXIgclFDdHJOYW1lID0gY29udHJvbGxlci50b0xvd2VyQ2FzZSgpICsgJy5qcyc7XG5cdFx0dmFyIGZpbGVzID0gZnMucmVhZGRpclN5bmMoY29udHJvbFBhdGgpO1xuXHRcdHZhciBjb250cm9sbGVyTmV3ID0gbnVsbDtcblx0XHRmaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuXHRcdFx0dmFyIGxvd2VyRmlsZU5hbWUgPSBmaWxlLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRpZiAobG93ZXJGaWxlTmFtZSA9PT0gclFDdHJOYW1lKSB7XG5cdFx0XHRcdGNvbnRyb2xsZXJOZXcgPSBmaWxlO1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRpZiAoY29udHJvbGxlck5ldyAhPSBudWxsKSB7XG5cdFx0XHR2YXIgY2xzID0gcmVxdWlyZShjb250cm9sUGF0aCArIGNvbnRyb2xsZXJOZXcpO1xuXHRcdFx0aGFuZGxlID0gbmV3IGNsc1snZGVmYXVsdCddKCk7XG5cdFx0XHRpZiAoTGlicy5pc0JsYW5rKHBhdGhTcGxpdFsyXSkpIHtcblx0XHRcdFx0Ly8gcGF0aFNwbGl0WzJdID0gZGVmYXVsdEZ1bmN0aW9uO1xuXHRcdFx0XHRsb2cuaW5mbyhcIk5vIHJlcXVlc3QgZnVuY3Rpb24gZm91bmQgZm9yIFwiICsgbWV0aG9kKTtcblx0XHRcdFx0cmVzcC53cml0ZUhlYWQoNDA0LCB7XG5cdFx0XHRcdFx0XCJDb250ZW50LVR5cGVcIjogXCJ0ZXh0L3BsYWluXCJcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJlc3Aud3JpdGUoXCI0MDQgcmVxdWVzdCBoYW5kbGVyIE5vdCBmb3VuZFwiKTtcblx0XHRcdFx0cmVzcC5lbmQoKTtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0dmFyIG1ldGhvZCA9IHBhdGhTcGxpdFsyXTtcblx0XHRcdC8vIHZhciBtZXRob2QgPSBhY3Rpb247XG5cdFx0XHRoYW5kbGVSZXF1ZXN0KHJlcSwgcmVzcCwgaGFuZGxlLCBtZXRob2QpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRsb2cuaW5mbyhcIk5vIHJlcXVlc3QgZmlsZSBmb3VuZCBmb3IgXCIgKyBwYXRobmFtZSk7XG5cdFx0XHRyZXNwLndyaXRlSGVhZCg0MDQsIHtcblx0XHRcdFx0XCJDb250ZW50LVR5cGVcIjogXCJ0ZXh0L3BsYWluXCJcblx0XHRcdH0pO1xuXHRcdFx0cmVzcC53cml0ZShcIjQwNCByZXF1ZXN0IGhhbmRsZXIgTm90IGZvdW5kXCIpO1xuXHRcdFx0cmVzcC5lbmQoKTtcblx0XHR9XG5cdH1cbn1cblxucm91dGUuY2hlY2tQYXRoUmVmZXJlciA9IChyZXEpID0+e1xuXHR0cnl7XG5cdFx0bGV0IHJlcV9wYXRoID0gcmVxLmhlYWRlcnNbJ3JlcS1wYXRoJ107XG5cdFx0bGV0IHJlZmVyZXIgPSBmYWxzZTtcblx0XHRsZXQgcGF0aFJlZmVyZXIgPSBmYWxzZTtcblx0XHRpZihyZXFfcGF0aCl7XG5cdFx0XHRyZWZlcmVyID0gcmVxX3BhdGhcblx0XHR9ZWxzZXtcblx0XHRcdHJlZmVyZXIgPSByZXEuaGVhZGVycy5yZWZlcmVyXG5cdFx0fVxuXHRcdGlmKHJlZmVyZXIpe1xuXHRcdFx0cGF0aFJlZmVyZXIgPSB1cmwucGFyc2UocmVmZXJlciwgZmFsc2UpLnBhdGhuYW1lO1xuXHRcdH1cblx0XHRyZXR1cm4gcGF0aFJlZmVyZXI7XG5cdH1jYXRjaChleCl7XG5cdFx0Y29uc29sZS5sb2coXCJjaGVja1BhdGhSZWZlcmVyIGVycm9yOlwiLCBleCk7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblx0XG59XG5leHBvcnRzLnJvdXRlID0gcm91dGU7Il19