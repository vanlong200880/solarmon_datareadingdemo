<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store"> 
    <sql id="access">
        <if test="userRole == 'partner'">
            AND s.brand_id IN (
              SELECT id
              FROM brands
              WHERE company_id = #{companyId}
            )
        </if>
        <if test="userRole == 'agent'">
            AND s.agent_id = #{userId}
        </if>
        <if test="userRole == 'contractor' or userRole == 'technician'">
            AND s.id IN (
              SELECT DISTINCT store_id
              FROM requests
              WHERE contractor_company_id = #{companyId}
            )
        </if>
    </sql>

    <select id="getList">
        SELECT s.*

        <if test="withBrand">, br.name AS brand_name</if>
        <if test="withBuilding">, bu.name AS building_name</if>
        <if test="withCity">, c.id AS city_id, c.name AS city_name</if>

        FROM stores s

        INNER JOIN brands br ON br.id=s.brand_id
        INNER JOIN buildings bu ON bu.id=s.building_id
        INNER JOIN cities c ON c.id=bu.city_id

        <where>
            <include refid="access"/>
        </where>

        ORDER BY c.name, bu.name, br.name
    </select>
</mapper>